<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

  <link rel="stylesheet"
        href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">

  <link crossorigin="anonymous"
        href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.0/dist/css/bootstrap.min.css"
        integrity="sha384-gH2yIJqKdNHPEq0n4Mqa/HGKIhSkIHeL5AyhkYV8i59U5AR6csBvApHHNl/vI1Bx"
        rel="stylesheet">
  <script crossorigin="anonymous"
          integrity="sha384-A3rJD856KowSb7dwlZdYEkO39Gagi7vIsF0jrRAoQmDKKtQBHUuLZ9AsSv4jD4Xa"
          src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.0/dist/js/bootstrap.bundle.min.js">
  </script>

  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@10"></script>

  <!--상단 아이콘-->
  <link rel="icon" href="https://cdn-icons-png.flaticon.com/128/1864/1864497.png" />

  <script src="https://cdn.jsdelivr.net/npm/js-cookie@3.0.5/dist/js.cookie.min.js"></script>

  <link rel="stylesheet" type="text/css"  href="/css/category.css">

  <style>

  </style>


</head>

<body>

<!-- 상단 메뉴 (+ 네비게이션 메뉴)-->
<div class="header">
  <div class="right">
    <a id="login" onclick="redirectToLoginPage()">
      <button>로그인</button>
    </a>
    <a id="logout" onclick="logout()">
      <button>로그아웃</button>
    </a>
    <a id="keeplogin" onclick="refreshAccessToken()">
      <button>로그인 연장</button>
    </a>
  </div>
  <div class="middle">
    <!-- 가운데 코끼리 글씨 및 로고  -->
    <img src="https://cdn-icons-png.flaticon.com/128/1864/1864497.png" style="width: 35px; height: 35px; cursor: pointer" onclick="gotoMain()"> <!-- 로고 이미지 추가 -->
    <div style="text-align: center; cursor:pointer;" onclick="gotoMain()">
      코끼리
    </div>
  </div>
  <div class="left">
    <!-- 알림, 우측 메뉴 슬라이드 -->
    <div class="notification-icon">
      <div style="position: relative;">
        <i class="far fa-bell" style="color: #cfcfcf;"></i>
        <span id="notificationBadge" class="nobadge" style="display:none;"></span>
      </div>
    </div>

    <div style="text-align: center;" type="button" data-bs-toggle="offcanvas"
         data-bs-target="#offcanvasWithBothOptions" aria-controls="offcanvasWithBothOptions">
      <img src="https://cdn-icons-png.flaticon.com/128/8212/8212733.png"
           style="width: 40px; height: 40px;"> <!-- 로고 이미지 추가 -->
    </div>

    <div class="offcanvas offcanvas-start w-25" data-bs-scroll="true" tabindex="-1"
         id="offcanvasWithBothOptions" aria-labelledby="offcanvasWithBothOptionsLabel">
      <div class="offcanvas-header" style="text-align: center; align-items:center;">
        <h5 class="offcanvas-title" id="offcanvasWithBothOptionsLabel" style="color:#000">
          <img src="https://cdn-icons-png.flaticon.com/128/1864/1864497.png"
               style="width: 40px; height: 40px;"> <!-- 로고 이미지 추가 -->
          코끼리
        </h5>
        <button type="button" class="btn-close" data-bs-dismiss="offcanvas"
                aria-label="Close"></button>
      </div>

      <div class="list-group list-group-flush">
        <!-- 카테고리 버튼과 하위 메뉴 -->
        <button class="list-group-item list-group-item-action" data-bs-toggle="collapse"
                data-bs-target="#categoryMenu">게시판 카테고리
        </button>
        <div id="categoryMenu" class="collapse">
          <a href="/api/posts/categories/1"
             class="list-group-item list-group-item-action mini-list">협업 인원 모집</a>
          <a href="/api/posts/categories/2"
             class="list-group-item list-group-item-action mini-list">스티디원 모집</a>
          <a href="/api/posts/categories/3"
             class="list-group-item list-group-item-action mini-list">문제은행</a>
          <a href="/api/posts/categories/4"
             class="list-group-item list-group-item-action mini-list">자유게시판</a>
        </div>

        <a href="/api/view/users" class="list-group-item list-group-item-action">마이페이지</a>
        <a href="/api/boards" class="list-group-item list-group-item-action">프로젝트 페이지</a>
        <a href="/api/chatRooms" class="list-group-item list-group-item-action">채팅 페이지</a> <!--채팅 페이지 테스트 중-->
        <a href="/api/view/admins" class="list-group-item list-group-item-action" th:if="${admin}">관리자 페이지</a> <!--서버에서 admin 여부 true/false로 가져오기-->


      </div>

    </div>

  </div>

</div>

<!-- 나머지 내용 -->
<div class="notification-list" id="notificationList">
  <div class="notification-list-header">
    <!-- 전체읽음 버튼 추가 -->
    <button id="markAllReadButton" class="mark-all-read-button">전체 읽음</button>
    알림
  </div>
</div>


<!--상단바 아래 제목과 게시글 영역-->
<div class="bottom">
  <div class="bottomone">
    <div class="bottomonewrapper">
      <!--카테고리 출력-->
      <div class="text-center">
        <text th:text="${categoryName}"></text>
      </div>

      <!--검색 창-->
      <div id="search-bar">
        <input type="text" id="search-input" placeholder="게시글 제목 검색"
               style="height: 34px; padding:10px;">
        <button onclick="searchByTitle()" style="
                background-color: #e6e6e6; color: #1a1313;
                border:none; margin-left: 10px;" class="btn btn-primary">검색
        </button>
      </div>

      <!-- 게시글 생성 버튼 -->
      <div class="button-center">
        <button type="button" class="btn btn-primary" id="create-post-button"
                style="
                background-color: #e6e6e6; color: #1a1313;
                border:none;" data-bs-toggle="modal" data-bs-target="#exampleModal">게시글 생성
        </button>
      </div>
    </div>
  </div>

  <div class="bottomtwo">
    <!--게시글 목록 코드-->
    <div class="card" id="cardArea" th:each="post, postIndex : ${posts}">
      <div class="card-body" style="text-align: left;">
        <a th:href="@{/api/posts/{postId}(postId=${post.id})}">
          <h5 class="card-title"
              th:text="|${post.title.length() > 15 ? #strings.substring(post.title, 0, 15) + '...' : post.title}|">
          스터디원 구함 </h5>
          <h6 class="card-subtitle mb-3 text-body-secondary"
              th:text="|View : ${post.view_cnt}|">
            View: 15</h6>
          <p class="card-text"
             th:text="|${post.content.length() > 50 ? #strings.substring(post.content, 0, 50) + '...' : post.content}|"
          >Some quick example text to build on the card title ...</p>
        </a>
        <p class="card-link" style="
                margin: revert;
                /* text-align: right; */
                /* margin-top: 90%; */
                display: flex;
                flex-direction: row;
                justify-content: flex-end;"
           th:text="|${post.nickname}|">sally</p>
        <p class="card-link" style="
    font-size: small;
    text-align: right;
"
           th:text="${#temporals.format(post.createdAt, 'MM/dd HH:mm:ss')}">11/11 11:11:11</p>
      </div>
    </div>

    <!--    <div>-->
    <!--      <ol class="list-group list-group" style="width: 65%;-->
    <!--margin-left: 17%; margin-top: 2%;">-->
    <!--        <li class="list-group-item d-flex justify-content-between align-items-start"-->
    <!--            th:each="post, postIndex : ${posts}">-->
    <!--          <div class="fw-bold-left" th:text="${postIndex.index + 1}"></div>-->
    <!--          <div class="ms-3 me-auto" style="-->
    <!--    text-align: left;-->
    <!--">-->
    <!--            <a th:href="@{/api/posts/{postId}(postId=${post.id})}">-->
    <!--              <div class="fw-bold-left" th:text="|제목 : ${post.title}|"></div>-->
    <!--              <span-->
    <!--                  th:text="|내용 : ${post.content.length() > 10 ? #strings.substring(post.content, 0, 10) + '...' : post.content}|"></span>-->
    <!--            </a>-->
    <!--          </div>-->
    <!--          <span class="badge bg-primary rounded-pill" style="font-size: 15px; width: 10%;"-->
    <!--                th:text="|조회수 : ${post.view_cnt}|"></span>-->
    <!--        </li>-->
    <!--      </ol>-->
    <!--    </div>-->
  </div>

  <!--페이징 처리 코드 -->
  <div class="bottomthree">
    <!-- 페이징처리 시작 -->
    <div th:if="${!posts.isEmpty()}">
      <ul class="pagination justify-content-center custom-pagination">
        <li class="page-item" th:classappend="${!posts.hasPrevious()} ? 'disabled'">
          <a class="page-link"
             th:href="@{|?page=${posts.getPageable().getPageNumber() - 1}|}">
            <span>이전</span>
          </a>
        </li>
        <!--                <li th:each="page: ${#numbers.sequence(0, boards.getTotalPages() -1)}"-->
        <!--                    th:if="${page >= page - 5 and page <= page + 5}"-->
        <!--                    th:classappend="${page == boards.getPageable().getPageNumber()} ? 'active'"-->
        <!--                    class="page-item">-->
        <!--                    <a th:text="${page + 1}" class="page-link" th:href="@{|?page=${page + 1}|}" style="background-color: #e6e6e6;">1</a>-->
        <!--                </li>-->

        <li th:each="page: ${#numbers.sequence(0, posts.getTotalPages() -1)}"
            th:if="${page >= page - 5 and page <= page + 5}"
            class="page-item">
          <a th:text="${page + 1}" class="page-link"
             th:href="@{|?page=${page + 1}|}"
             th:style="${page == posts.getPageable().getPageNumber()} ? 'background-color: #f5f5fa;' : ''">1</a>
        </li>


        <li class="page-item" th:classappend="${!posts.hasNext()} ? 'disabled'">
          <a class="page-link" th:href="@{|/page=${posts.getPageable().getPageNumber() + 2}|}">
            <span>다음</span>
          </a>
        </li>
      </ul>
    </div>
    <!-- 페이징처리 끝 -->
  </div>

</div>


<script>
  function gotoMain() {
    window.location.href = "/main";
  }

  // 게시글 생성 버튼 클릭 이벤트 핸들러
  $("#create-post-button").click(function () {
    // 게시글 생성 페이지로 이동
    window.location.href = "/api/post-page";
  });

  //titlecontaing 검색
  function searchByTitle() {
    // 검색어 가져오기
    const currentURL = new URL(window.location.href);
    const category = currentURL.pathname.split('/')[4]; // 주소창에서 category값 받아오기
    const searchInput = document.getElementById("search-input").value;
    console.log(category);

    // 검색 결과 페이지로 이동
    window.location.replace("/api/posts/categories/" + category + "/titles?title=" + searchInput);
  }

  const Toast = Swal.mixin({
    toast: true,
    position: 'center-center',
    showConfirmButton: false,
    timer: 1000,
    timerProgressBar: true,
    didOpen: (toast) => {
      toast.addEventListener('mouseenter', Swal.stopTimer)
      toast.addEventListener('mouseleave', Swal.resumeTimer)
    }
  })

  // header js 추가
  $(document).ready(function () {
    pageSetting();

    const notificationIcon = document.querySelector('.notification-icon');
    const notificationBadge = document.getElementById('notificationBadge');
    const notificationList = document.getElementById('notificationList');
    let isNotificationListOpen = false;
    let notificationsList = []; // 알림 데이터를 저장할 리스트
    let userId = null; // 사용자 아이디 변수 추가

    // 알림 데이터를 서버에서 불러와서 목록에 추가하는 함수
    const fetchNotifications = async (userId) => {
      try {
        const response = await fetch(`/api/notifications/list/${userId}`);
        if (response.ok) {
          const notifications = await response.json();
          notificationsList = notifications;
          updateNotificationList();
          updateNotificationIcon();
        } else {
          console.error('Error fetching notifications:', response.status);
        }
      } catch (error) {
        console.error('Error fetching notifications:', error);
      }
    };

    // 사용자 정보를 불러오는 함수
    const fetchUserInfo = async () => {
      try {
        const response = await fetch('/api/get-user-info');
        if (response.ok) {
          const userData = await response.json();
          if (userData && userData.id) {
            userId = userData.id;
            loadNotificationsFromServer(userId);
          }
        } else {
          console.error('Error fetching user info:', response.status);
        }
      } catch (error) {
        console.error('Error fetching user info:', error);
      }
    };

    // 페이지 로드 시 사용자 정보를 가져와서 알림 데이터를 불러옴
    const token = Cookies.get('Authorization');
    if (token) { // 토큰 있을 경우
      fetchUserInfo();
    }

    // 알림 목록 업데이트 함수
    const updateNotificationList = () => {
      notificationList.innerHTML = ''; // 목록 초기화
      notificationsList.forEach(notification => {
        addNotificationToList(notification);
      });
      const listHeader = document.createElement('div');
      listHeader.className = 'notification-list-header';

      // Create the "전체 읽음" button
      const markAllReadButton = `
        <button id="markAllReadButton" class="mark-all-read-button">전체 읽음</button>
    `;
      listHeader.innerHTML = markAllReadButton; // innerHTML로 버튼 추가
      listHeader.innerHTML += '알림';

      notificationList.insertBefore(listHeader, notificationList.firstChild);

      // "전체 읽음" 버튼에 이벤트 리스너 연결
      const button = document.getElementById('markAllReadButton');
      button.addEventListener('click', function () {
        Swal.fire({
          icon: "waning",
          title: "알림 전체 읽음처리 하시겠습니까?"
        }).then((result) => {
          if (result.isConfirmed) {
            markAllNotificationsAsRead();
            window.location.reload();
          }
        })
      });
    }

    // 현재 시간과 주어진 시간 사이의 경과 시간을 계산하여 문자열로 반환하는 함수
    const formatTimeAgo = (notificationTime) => {
      const currentTime = new Date();
      const timeDifference = currentTime - new Date(notificationTime);

      if (timeDifference < 60000) { // 1분 미만
        return "방금 전";
      } else if (timeDifference < 3600000) { // 1시간 미만
        const minutes = Math.floor(timeDifference / 60000);
        return `${minutes}분 전`;
      } else if (timeDifference < 86400000) { // 24시간 미만
        const hours = Math.floor(timeDifference / 3600000);
        return `${hours}시간 전`;
      } else {
        const days = Math.floor(timeDifference / 86400000);
        return `${days}일 전`;
      }
    };

    // 알림 아이템 추가 함수
    const addNotificationToList = (notification) => {
      const listItem = document.createElement('div');
      listItem.className = notification.read ? 'notification-list-item read'
          : 'notification-list-item unread';
      const timeAgo = formatTimeAgo(notification.createdAt);
      listItem.innerHTML = `${notification.content}<br><span class="notification-time">${timeAgo}</span>`;
      listItem.onclick = () => {
        handleNotificationItemClick(notification, listItem);
      };
      notificationList.insertBefore(listItem, notificationList.firstChild);
    };

    // 알림 읽음 처리 함수
    const markNotificationAsRead = (notification, listItem) => {
      if (!notification.read) {
        notification.read = true;
        listItem.classList.remove('unread');
        listItem.classList.add('read');
        updateNotificationIcon();

        // AJAX 요청으로 서버에 알림 읽음 처리 요청 보내기
        $.post(`/api/mark-notification-as-read/${notification.id}`)
      }
    };

    // 알림 아이템 클릭 처리 함수
    const handleNotificationItemClick = (notification, listItem) => {
      markNotificationAsRead(notification, listItem);
      window.location.href = notification.url;
    };

    // 알림 아이콘 업데이트 함수
    const updateNotificationIcon = () => {
      const unreadCount = notificationsList.filter(notification => !notification.read).length;
      if (unreadCount > 0) {
        notificationIcon.classList.add('new-notification');
        notificationBadge.style.display = "inline";
        notificationBadge.innerText = unreadCount.toString();
      } else {
        notificationIcon.classList.remove('new-notification');
        notificationBadge.style.display = "none";
        // notificationBadge.innerText = '';
      }
    };

    // 종모양 아이콘 클릭 시 알림 목록 표시/숨기기
    notificationIcon.addEventListener('click', () => {
      updateNotificationList();
      if (!isNotificationListOpen) {
        notificationList.style.display = 'block';
        isNotificationListOpen = true;
      } else {
        notificationList.style.display = 'none';
        isNotificationListOpen = false;
      }
    });

    // 페이지 로드 시 알림 데이터를 가져와서 표시
    const loadNotificationsFromServer = (userId) => {
      fetchNotifications(userId);
    };

    fetchUserInfo().then(() => {
      const sse = new EventSource(`/api/notifications/${userId}`);
      sse.onmessage = (event) => {
        const notification = JSON.parse(event.data);
        notificationsList.push(notification);
        addNotificationToList(notification);
        updateNotificationIcon();
      };
    });

    // 알림 전체 읽음 처리 함수
    function markAllNotificationsAsRead() {
      $.post(`/api/mark-all-notifications-as-read/${userId}`)
              .done(function(response) {
                Toast.fire({
                  icon: 'success',
                  title: "전체 읽음 처리 되었습니다!",
                })
              })
              .fail(function(response) {
                Toast.fire({
                  icon: 'error',
                  title: "전체 읽음 처리 실패!",
                })
              });
    }
  });

  function removeToken() { // 토큰 삭제
    Cookies.remove('Authorization', {path: '/'});
  }

  /* 서버 통신 메서드 */
  function refreshAccessToken() { // 엑세스 토큰 갱신
    $.ajax({
      type: "GET",
      url: `/api/auth/refresh/access-token`,
      contentType: "application/json",
      success: function (data) {
        console.log(data);
        Toast.fire({
          icon: 'success',
          title: "로그인 연장 성공",
        })
      },
      error: function (data) {
        console.log(data);
        Toast.fire({
          icon: 'error',
          title: "로그인 연장 실패. 재로그인 부탁드립니다.",
        })
        redirectToLoginPage();
      }
    });
  }

  /* 페이지 첫 로드 메서드 */
  function pageSetting() {  // main page 세팅
    const token = Cookies.get('Authorization');
    const rtoken = Cookies.get('RefreshToken');
    console.log(token);
    console.log(rtoken);

    const loginBtn = document.getElementById('login');
    const logoutBtn = document.getElementById('logout');
    const keeploginBtn = document.getElementById('keeplogin');

    if (!token) {
      loginBtn.style.display = "inline-block";
      logoutBtn.style.display = "none";
      keeploginBtn.style.display = "none";
    } else {
      loginBtn.style.display = "none";
    }

  }

  function logout() { // 로그아웃
    $.ajax({
      type: "DELETE",
      url: `/api/auth/logout`,
      contentType: "application/json",
      success: function (data) {
        removeToken();
        Toast.fire({
          icon: 'success',
          title: "로그아웃 성공",
        }).then(function () {
          window.location.href = "/main";
        })

      },
      error: function () {
        Toast.fire({
          icon: 'error',
          title: "로그아웃 실패",
        }).then(function () {
          window.location.reload();
        })
      }
    });
  }

  function redirectToLoginPage() {
    window.location.href = "/api/auth/login-page";
  }


</script>
</body>
</html>
